---
import Layout from '../../layouts/layout.astro'
import { Books } from '@components/books'
import {
  getAuthorsWithBooks,
  getAuthorById,
  getReleasedBooksByAuthor,
  type BookWithAuthors,
} from '@lib/data'
import type { Author } from 'db/schema'

type Props = {
  data: {
    author: Author
    books: BookWithAuthors[]
  }
}

export async function getStaticPaths() {
  const authors = await getAuthorsWithBooks()
  const paths = authors
    .filter((author) => author.books && author.books.length > 0)
    .map(async (author) => {
      const authorData = await getAuthorById(author.id)
      const books = await getReleasedBooksByAuthor(author.id)

      return {
        params: {
          id: author.id,
        },
        props: {
          data: {
            author: authorData,
            books,
          },
        },
      }
    })

  return await Promise.all(paths)
}

export const prerender = true

const { id } = Astro.params
const { data } = Astro.props
---

<Layout data-id={id} title={`${data.author?.name_ko}: 책들 | managn`}>
  <Books data={data.books} />
</Layout>
